<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<!--Converted with LaTeX2HTML 96.1 (Feb 5, 1996) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds -->
<HTML>
<HEAD>
<TITLE>Adding Lisp Functions Coded in C</TITLE>
<META NAME="description" CONTENT="Adding Lisp Functions Coded in C">
<META NAME="keywords" CONTENT="manual">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<LINK REL=STYLESHEET HREF="manual.css">
</HEAD>
<BODY LANG="EN">
 <A NAME="tex2html3068" HREF="node87.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="./icons/next_motif.gif"></A> <A NAME="tex2html3066" HREF="node74.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="./icons/up_motif.gif"></A> <A NAME="tex2html3060" HREF="node85.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="./icons/previous_motif.gif"></A> <A NAME="tex2html3070" HREF="node1.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="./icons/contents_motif.gif"></A> <A NAME="tex2html3071" HREF="node153.html"><IMG WIDTH=43 HEIGHT=24 ALIGN=BOTTOM ALT="index" SRC="./icons/index_motif.gif"></A> <BR>
<B> Next:</B> <A NAME="tex2html3069" HREF="node87.html">Foreign Language Interface</A>
<B>Up:</B> <A NAME="tex2html3067" HREF="node74.html">System Functions</A>
<B> Previous:</B> <A NAME="tex2html3061" HREF="node85.html">Unix Processes</A>
<BR> <P>
<H2><A NAME="SECTION04014000000000000000">Adding Lisp Functions Coded in C</A></H2>
<P>
Programs that heavily refer to C include files or frequently access arrays
perform better or are more clearly described
if written in C or other languages rather than in EusLisp.
EusLisp provides the way to link programs coded in C.
<P>
If you want to define EusLisp function written in C,
each EusLisp-callable C-function must be coded to accept three arguments:
the context pointer, the number of arguments and the pointer to the Lisp
argument block.
These arguments must be named as <TT>ctx, n</TT> and <TT>argv</TT>,
since the macros in <TT>c/eus.h</TT> assume these names.
The C program must include <TT>*eusdir*/c/eus.h</TT>.
The programmer should be familiar with the types and macros
described there.
The entry function should be named by the basename of the source file.
<P>
A sample code for C function AVERAGE which computes the arithmetic
average of arbitrary number of floats is shown below.
In this example, you can see how to get float values from arguments,
how to make the pointer of a float,
how to set a pointer in the special variable AVERAGE,
and how to define a function and a symbol in the entry function <TT>ave</TT>.
Compile this program by <TT>'cc -c -Dsun4 -DSolaris2 -K pic'</TT>.
<TT>-Dsun4</TT> and <TT>-DSolaris2</TT> are needed
to chose proper definitions in <TT>c/eus.h</TT>.
<TT>-K pic</TT> is needed to let the c compiler generate position independent
code necessary for the loadable shared object. 
Then the resulted '.o' file can be loaded into EusLisp.
More complete examples can be found in <TT>*eusdir*/clib/*.c</TT>,
which are defined and loaded in the same manner described here.
<P>
<PRE>/* ave.c */
/* (average &amp;rest numbers) */
#include &quot;/usr/local/eus/c/eus.h&quot;
static pointer AVESYM;
pointer AVERAGE(ctx,n,argv)
context *ctx;
int n;
pointer argv[];
{ register int i;
  float sum=0.0, a, av;
  pointer result;
  numunion nu;
  for (i=0; i&lt;n; i++) {
    a=ckfltval(argv[i]);
    sum += a;} /*get floating value from args*/
  av=sum/n;
  result=makeflt(av);
  AVESYM-&gt;c.sym.speval=result;  /*kindly set the result in symbol*/
  return(result);}

ave(ctx,n,argv)
context *ctx;
int n;
pointer argv[];
{ char *p;
  p=&quot;AVERAGE&quot;;
  defun(ctx,p,argv[0],AVERAGE);
  AVESYM=intern(ctx,p,strlen(p),userpkg); /* make a new symbol*/
  }</PRE>
<P>
<BR> <HR>
<P><ADDRESS>
<I>Hirofumi Nakagaki <BR>
Tue Mar 19 19:45:39 JST 1996</I>
</ADDRESS>
</BODY>
</HTML>
