<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<!--Converted with LaTeX2HTML 96.1 (Feb 5, 1996) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds -->
<HTML>
<HEAD>
<TITLE>Compilation</TITLE>
<META NAME="description" CONTENT="Compilation">
<META NAME="keywords" CONTENT="manual">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<LINK REL=STYLESHEET HREF="manual.css">
</HEAD>
<BODY LANG="EN">
 <A NAME="tex2html2732" HREF="node67.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="./icons/next_motif.gif"></A> <A NAME="tex2html2730" HREF="node63.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="./icons/up_motif.gif"></A> <A NAME="tex2html2724" HREF="node65.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="./icons/previous_motif.gif"></A> <A NAME="tex2html2734" HREF="node1.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="./icons/contents_motif.gif"></A> <A NAME="tex2html2735" HREF="node153.html"><IMG WIDTH=43 HEIGHT=24 ALIGN=BOTTOM ALT="index" SRC="./icons/index_motif.gif"></A> <BR>
<B> Next:</B> <A NAME="tex2html2733" HREF="node67.html">Program Loading</A>
<B>Up:</B> <A NAME="tex2html2731" HREF="node63.html">Evaluation</A>
<B> Previous:</B> <A NAME="tex2html2725" HREF="node65.html">Top-level Interaction</A>
<BR> <P>
<H2><A NAME="SECTION03093000000000000000">Compilation</A></H2>
<A NAME="compiler">&#160;</A>
<P>
EusLisp compiler is used to speed the execution of Lisp programs.
You can expect 5 to 30 times faster execution and notable reduction of garbage
collection time elapsed by macro expansion.
<P>
Euscomp does optimization for arithmetic operation and vector access.
Sometimes proper type declarations are needed to inform
the compiler applicability of optimization.
<P>
<B>Compile-function</B> compiles functions one by one.
<B>Compile-file</B>  compiles an entire source file.
During the execution of <B>Compile-file</B>, each form in a file
is read and evaluated.
This may change the current EusLisp environment.
For examples, <B>defparameter</B>
may set a new value to a symbol and <B>defun</B> may substitute the existing
compiled function with its non-compiled version.
To avoid these unexpected effects, use the <B>eval-when</B> special form
without compile time situation,
or use <B>euscomp</B> command to run the compiler as a separate process.
<P>
<B>Euscomp</B> is a unix command, which is usually a symbolic link to <B>eus</B>.
It recognizes several options.
-O flag indicates optimization of the C compiler.
Each of -O1,-O2, -O3 indicates optimization level of EusLisp compiler,
which is equivalent to proclaiming (optimize 1 or 2 or 3).
Each of -S0, -S1, -S2, -S3 set 0,1,2 and 3 to compiler:*safety*.
If *safety* is less than 2, no code for checking interrupt is emitted,
and you will lose control if the program enters an infinite loop.
If *safety* is zero, the number of required arguments is not checked.
-V flag is used to print function names when they are compiled (verbose).
-c flag prevents from forking and exec'ing cc.
-D pushes next argument to the <B>*features*</B> list, which can be used for
conditional compilation in conjunction with #- and #+ read-macro.
<P>
The compiler translates EusLisp source program named as &quot;xxx.l&quot; 
into the intermediate C program file named &quot;xxx.c&quot; and the  header file
named &quot;xxx.h&quot;.
Then the C compiler is run and &quot;xxx.o&quot; is generated.
Intermediate files &quot;xxx.c&quot; and &quot;xxx.h&quot; are left
for the purpose of cross compilation:
usually you only need to compile &quot;xxx.c&quot; files by cc unix command
when you wish to use the code on machines of different architecture.
Compiled code is loaded to EusLisp by '(load &quot;xxx&quot;)'.
<P>
Each intermediate file refers to the &quot;eus.h&quot; header file, which is
supposed to be located in the <TT>*eusdir*/c</TT> directory.
<TT>*eusdir*</TT> is copied from the <TT>EUSDIR</TT> environment variable.
If none is set, <TT>/usr/local/eus/</TT> is taken as the default directory.
<P>
When compiled, intermediate C programs are usually much bigger than
the original source code. For example, 1,161 lines of &quot;l/common.l&quot;
lisp source expands to 8,194 lines of &quot;l/common.c&quot; and 544 lines of &quot;l/common.h&quot;.
Compiling 1,000 lines of lisp source is not a hard task, but 
optimized compililation of nearly 10,000 lines of C program not only takes
long time (several minutes), but also consumes much disk space.
So if you are compiling relatively big programs, be sure your machine has
sufficient /var/tmp disk, otherwise CC may die.
Setting the <TT>TEMPDIR</TT> environment variable to a bigger disk slice may help.
<P>
As the linkage is performed at load-time or at run-time,
no recompilation  is required even the eus kernel is updated.
On the other hand, run-time linkage may impose you another inconvenience.
Suppose you have two functions A and B in a file &quot;x.l&quot; and A calls B.
After compiling &quot;x.l&quot;, you load &quot;x.o&quot; and tries to call A which internally
calles B.
Then you find a bug in B, and probably you would redefine B.
Here, you have compiled A and non-compiled B.
You may call A again, but nothing will change, since A still calls
old compiled B which is linked regidly when A first called B.
To avoid this problem, A must be redefined again,
or B must be redefined just after &quot;x.o&quot; is loaded and before A is called.
<P>
When a compiled-code is loaded, its top level code, which is normally
a series of defun, defmethod, etc.,  is excuted. This top level code
is defined as the entry function of the load module.
The compiler names the entry function,
and the loader has to know the exact name of this function.
To make the situation simple, both the compiler and the loader assume
the entry function name is identical to the basename of the object file.
For example, if you are compile and load &quot;fib.l&quot;,
the compiler produce &quot;fib(...)&quot; as the entry function of &quot;fib.c&quot;,
and the loader looks for &quot;fib&quot; in the &quot;fib.o&quot; object file.
Since the final object file is produced by &quot;cc&quot; and &quot;ld&quot; of unix, 
this entry function name has to satisfy the naming rule of C functions.
Therefore, you have to avoid C's reserved keywords
such as &quot;int&quot;, &quot;struct&quot;, &quot;union&quot;, &quot;register&quot;, &quot;extern&quot;, etc., or
the private identifiers defined in &quot;c/eus.h&quot; such as &quot;pointer&quot;, &quot;cons&quot;,
&quot;makeint&quot;, etc., to be used as the name of the file.
If you have to use one of these reserved words as the name of the
source file, you specify it for <EM>:entry</EM> arguments of
the compiler and the loader.
<P>
A restriction exists for the usage of closure:
<B>return-from</B> special form in closures and clean-up forms in 
unwind-protect is not always correctly compiled.
<P>
<B>Disassemble</B> is not implemented.
In order to analyze compiled code, see the intermediate C program
or use <TT>adb</TT>.
<P>
<A NAME=9822>&#160;</A>
<B>euscomp</B> <EM>{filename}* </EM>[unix-command] 
<UL><LI> Invokes EusLisp compiler.
</UL>
<A NAME=9832>&#160;</A>
<P> <IMG  ALIGN=BOTTOM ALT="emtabbing9833" SRC="img32.gif"  > <P>
<UL><LI> 
compiles a file.
&quot;.l&quot; is assumed for the suffix of the <EM>srcfile.
If <EM>:verbose</EM> is T, names of functions and methods being compiled
are printed to make it easy to find the expressions where errors occurred.
<EM>:Optimize, :c-optimize</EM> and <EM>:safety</EM> specifies the optimization
levels. 
<EM>:Pic</EM> should be set T, unless the module is hard-linked in the
EusLisp core during the make stage.
<P>
</UL>
<A NAME=9853>&#160;</A>
<B>compile</B> <EM>funcname </EM>[function] 
<UL><LI> compiles a function. <B>Compile</B> first
prints the function definition into a temporary file.
The file is compiled by <B>compile-file</B> and then is loaded by <B>load</B>.
Temporary files are deleted.
</UL>
<A NAME=9866>&#160;</A>
<B>compile-file-if-src-newer</B> <EM>srcfile &amp;key compiler-options </EM>[function] 
<UL><LI> compiles the <EM>srcfile if it is newer (more recently modified) than
its corresponding object file. The object file is supposed to have
the &quot;.o&quot; suffix.
</UL>
<A NAME=9877>&#160;</A>
<B>*optimize*</B> <EM></EM>[variable] 
<UL><LI> controls optimization level.
</UL>
<A NAME=9887>&#160;</A>
<B>*verbose*</B> <EM></EM>[variable] 
<UL><LI> When set to non-nil, the name of a function or a method being compiled,
and the time required for the compilation are displayed.
</UL>
<A NAME=9897>&#160;</A>
<B>*safety*</B> <EM></EM>[variable] 
<UL><LI> controls safety level.
</UL>
<P>
</EM></EM><HR><A NAME="tex2html2732" HREF="node67.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="./icons/next_motif.gif"></A> <A NAME="tex2html2730" HREF="node63.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="./icons/up_motif.gif"></A> <A NAME="tex2html2724" HREF="node65.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="./icons/previous_motif.gif"></A> <A NAME="tex2html2734" HREF="node1.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="./icons/contents_motif.gif"></A> <A NAME="tex2html2735" HREF="node153.html"><IMG WIDTH=43 HEIGHT=24 ALIGN=BOTTOM ALT="index" SRC="./icons/index_motif.gif"></A> <BR>
<B> Next:</B> <A NAME="tex2html2733" HREF="node67.html">Program Loading</A>
<B>Up:</B> <A NAME="tex2html2731" HREF="node63.html">Evaluation</A>
<B> Previous:</B> <A NAME="tex2html2725" HREF="node65.html">Top-level Interaction</A>
<P><ADDRESS>
<I>Hirofumi Nakagaki <BR>
Tue Mar 19 19:45:39 JST 1996</I>
</ADDRESS>
</BODY>
</HTML>
